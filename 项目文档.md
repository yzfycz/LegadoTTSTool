# 语音合成角色导出工具 - 项目开发文档

## 项目概述

### 项目简介
这是一个专为盲人用户设计的语音合成角色管理工具，主要用于从各种TTS（文本转语音）API获取语音角色信息，并导出为阅读软件可导入的JSON格式。

### 技术栈
- **编程语言**: Python 3.8+
- **GUI框架**: wxPython
- **网络请求**: requests, gradio_client
- **配置文件**: JSON
- **无障碍支持**: wxPython原生无障碍API

### 核心特性
- 完全支持键盘操作，100%无死角操作体验
- 支持多种TTS提供商管理
- 动态界面生成，根据不同提供商显示不同配置选项
- 局域网自动搜索TTS服务器
- 实时语音试听功能
- 批量角色导出功能

## 开发背景与目标

### 用户需求分析
1. **目标用户**: 盲人用户或依赖屏幕阅读器的用户
2. **核心痛点**: 
   - 现有工具缺乏无障碍支持
   - 手动配置语音角色过于复杂
   - 需要一个简单易用的导出工具
3. **使用场景**: 将TTS服务器的语音角色导出到阅读软件中使用

### 开发目标
1. **无障碍优先**: 所有功能都必须支持键盘操作和屏幕阅读器
2. **简单易用**: 界面简洁，操作流程清晰
3. **稳定可靠**: 网络请求和错误处理完善
4. **可扩展性**: 支持多种TTS服务提供商

## 技术架构设计

### 1. 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                           │
├─────────────────────────────────────────────────────────────┤
│  主界面  │  提供商管理  │  配置界面  │  导出界面              │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        业务逻辑层                           │
├─────────────────────────────────────────────────────────────┤
│ ProviderManager │ TTSClient │ NetworkScanner │ JSONExporter │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据存储层                           │
├─────────────────────────────────────────────────────────────┤
│   providers.json   │   settings.json   │   导出文件         │
└─────────────────────────────────────────────────────────────┘
```

### 2. 模块职责划分

#### 核心业务模块
- **ProviderManager**: 提供商配置管理，包括增删改查操作
- **TTSClient**: TTS服务通信，处理角色获取和语音合成
- **NetworkScanner**: 局域网TTS服务器发现和验证
- **JSONExporter**: 角色数据格式转换和导出

#### 界面模块
- **MainFrame**: 主界面协调器，管理所有用户交互
- **ProviderDialog**: 提供商管理界面
- **ConfigDialog**: 动态配置表单生成器

#### 工具模块
- **Accessibility**: 无障碍功能支持
- **FileUtils**: 文件操作和配置管理
- **NetworkUtils**: 网络通信工具

## 详细开发流程

### 第一阶段：基础框架搭建

#### 1.1 项目结构设计
```
LegadoTTSTool/
├── main.py                 # 程序入口
├── config/                 # 配置文件目录
│   ├── providers.json      # 提供商配置
│   └── settings.json       # 程序设置
├── ui/                     # 界面模块
│   ├── main_frame.py       # 主界面
│   ├── provider_dialog.py  # 提供商管理
│   └── config_dialog.py    # 配置对话框
├── core/                   # 核心模块
│   ├── provider_manager.py # 提供商管理
│   ├── tts_client.py       # TTS客户端
│   ├── network_scanner.py  # 网络扫描
│   └── json_exporter.py    # JSON导出
├── utils/                  # 工具模块
│   ├── accessibility.py    # 无障碍工具
│   ├── file_utils.py       # 文件工具
│   └── network_utils.py    # 网络工具
└── 项目文档.md             # 项目文档
```

#### 1.2 基础框架实现
1. **应用程序类设计**: 继承wx.App，处理程序生命周期
2. **主窗口框架**: 创建基本窗口结构和菜单系统
3. **配置文件管理**: 实现JSON配置的读写和验证
4. **异常处理框架**: 建立全局异常处理机制

### 第二阶段：核心功能开发

#### 2.1 提供商管理系统
1. **数据模型设计**: 定义提供商的数据结构
2. **CRUD操作**: 实现增删改查功能
3. **动态表单**: 根据提供商类型生成不同配置字段
4. **配置验证**: 验证用户输入的有效性

#### 2.2 TTS客户端开发
1. **API接口封装**: 封装index TTS的Gradio API
2. **数据解析**: 处理API返回的复杂数据结构
3. **错误处理**: 完善的网络错误处理机制
4. **语音合成**: 实现实时语音试听功能

#### 2.3 网络扫描功能
1. **端口扫描**: 实现多线程端口扫描
2. **服务验证**: 验证扫描到的服务器是否为index TTS
3. **结果展示**: 友好的扫描结果展示

### 第三阶段：界面完善

#### 3.1 主界面完善
1. **控件布局**: 实现完整的界面布局
2. **事件处理**: 处理所有用户交互事件
3. **状态管理**: 管理界面状态和数据同步
4. **实时反馈**: 提供操作状态的实时反馈

#### 3.2 无障碍优化
1. **键盘导航**: 实现完整的键盘导航支持
2. **屏幕阅读器**: 添加完整的标签和提示文本
3. **焦点管理**: 优化焦点顺序和视觉反馈
4. **快捷键系统**: 实现全局和控件级快捷键

### 第四阶段：测试与优化

#### 4.1 功能测试
1. **单元测试**: 测试各个模块的核心功能
2. **集成测试**: 测试模块间的协作
3. **用户测试**: 邀请目标用户进行实际使用测试

#### 4.2 性能优化
1. **网络优化**: 优化网络请求的并发和超时处理
2. **内存优化**: 优化大列表的内存使用
3. **响应优化**: 提升界面响应速度

## 关键技术实现

### 1. ID生成策略
```python
def generate_unique_id(existing_ids=None):
    """
    生成唯一的正数时间戳ID
    使用毫秒级时间戳确保唯一性
    """
    timestamp = int(time.time() * 1000)
    
    # 确保ID唯一性
    if existing_ids:
        while timestamp in existing_ids:
            timestamp += 1
    
    return timestamp
```

### 2. API数据解析
```python
def parse_api_response(result):
    """
    解析Gradio API返回的复杂数据结构
    支持列表和字典两种格式
    """
    if isinstance(result, list):
        return [role.strip() for role in result if isinstance(role, str)]
    elif isinstance(result, dict) and 'choices' in result:
        return [choice[0] for choice in result['choices'] if isinstance(choice, list)]
    return []
```

### 3. 无障碍支持
```python
def setup_accessibility(control, name, description=""):
    """
    为控件设置无障碍支持
    包括名称、描述和帮助文本
    """
    if hasattr(control, 'SetName'):
        control.SetName(name)
    if hasattr(control, 'SetDescription'):
        control.SetDescription(description)
    if hasattr(control, 'SetHelpText'):
        control.SetHelpText(description)
```

## 数据结构设计

### 1. 提供商配置结构
```json
{
  "providers": [
    {
      "id": "uuid-string",
      "type": "index_tts",
      "custom_name": "我的TTS",
      "enabled": true,
      "server_address": "127.0.0.1",
      "web_port": 7860,
      "synth_port": 9880,
      "preview_text": "试听文本",
      "created_time": "2024-01-01T00:00:00Z",
      "last_used": null
    }
  ],
  "version": "1.0.0",
  "last_updated": "2024-01-01T00:00:00Z"
}
```

### 2. 导出数据结构
```json
[
  {
    "concurrentRate": "0",
    "contentType": "audio/wav",
    "enabledCookieJar": false,
    "id": 1640995200000,
    "lastUpdateTime": 1640995200000,
    "name": "角色名_提供商名",
    "url": "http://server:port/?text={{speakText}}&speaker=role&speed=1.0&volume=1.0"
  }
]
```

## 开发规范与最佳实践

### 1. 代码规范
- **命名规范**: 使用有意义的英文变量名和函数名
- **注释规范**: 关键功能必须有中文注释
- **异常处理**: 所有可能失败的操作都必须有异常处理
- **日志记录**: 重要操作需要记录日志

### 2. 无障碍开发规范
- **键盘支持**: 所有功能都必须支持键盘操作
- **标签完整**: 每个控件都必须有完整的无障碍标签
- **焦点逻辑**: 焦点顺序必须符合用户期望
- **状态反馈**: 操作状态必须及时反馈给用户

### 3. 网络编程规范
- **超时处理**: 所有网络请求都必须设置超时
- **重试机制**: 关键操作需要实现重试机制
- **错误提示**: 网络错误必须提供用户友好的提示
- **并发控制**: 合理控制并发请求数量

## 部署与发布

### 1. 环境要求
- Python 3.8+
- wxPython
- requests
- gradio_client
- pygame (音频播放)

### 2. 打包方案
- 使用PyInstaller打包为可执行文件
- 包含所有依赖库
- 生成安装程序

### 3. 版本管理
- 语义化版本号 (Major.Minor.Patch)
- 详细的更新日志
- 向后兼容性保证

## 维护与扩展

### 1. 问题跟踪
- 使用GitHub Issues跟踪问题
- 分类管理不同类型的问题
- 及时响应用户反馈

### 2. 功能扩展
- 支持更多TTS服务提供商
- 添加更多导出格式
- 实现插件系统

### 3. 性能监控
- 收集用户使用数据
- 监控程序性能指标
- 持续优化用户体验

## 总结

本项目是一个专为盲人用户设计的实用工具，通过无障碍设计和简洁的界面，让用户能够轻松管理TTS语音角色并导出到阅读软件中使用。项目采用模块化设计，具有良好的可扩展性和维护性。

开发过程中始终以用户体验为中心，特别注重无障碍支持的完整性，确保所有功能都能被键盘用户和屏幕阅读器用户正常使用。

---

**项目状态**: 开发中
**目标用户**: 盲人用户和依赖屏幕阅读器的用户
**开发理念**: 无障碍优先，简单易用，稳定可靠