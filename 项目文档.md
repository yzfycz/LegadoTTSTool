# 语音合成角色导出工具

## 项目概述

### 项目简介
这是一个专为盲人用户设计的语音合成角色管理工具，主要用于从各种TTS（文本转语音）API获取语音角色信息，并导出为阅读软件可导入的JSON格式。

### 技术栈
- **编程语言**: Python 3.8+
- **GUI框架**: wxPython
- **网络请求**: requests, gradio_client
- **配置文件**: JSON
- **无障碍支持**: wxPython原生无障碍API

### 核心特性
- 完全支持键盘操作，100%无死角操作体验
- 支持多种TTS提供商管理
- 动态界面生成，根据不同提供商显示不同配置选项
- 局域网自动搜索TTS服务器
- 实时语音试听功能
- 批量角色导出功能

## 功能需求

### 1. 主界面功能
- **方案选择**: 显示已配置的TTS提供商列表
- **角色刷新**: 从API获取可用的语音角色列表
- **角色选择**: 支持空格键多选，回车键试听
- **批量操作**: 全选、反选功能
- **参数调节**: 语速（0.5-2.0）、音量（0.5-2.0）实时调节
- **试听文本**: 可编辑的试听文本框，默认100字试听文本
- **导出功能**: 一键导出为阅读软件兼容的JSON格式

### 2. 提供商管理
- **提供商配置**: 新建、编辑、删除TTS提供商
- **动态表单**: 根据不同提供商类型显示不同的配置字段
- **局域网搜索**: 自动搜索局域网内的index TTS服务器
- **配置验证**: 自动验证配置的正确性

### 3. 菜单系统
- **操作菜单** (Alt+C):
  - 提供商管理 (M)
  - 帮助 (H) - 打开README.md
  - 关于 (A) - 显示版本信息
  - 退出 (E) - Alt+F4退出程序

### 4. 无障碍特性
- **键盘导航**: 完整的Tab键导航支持
- **快捷键**: 所有功能都有对应的快捷键
- **屏幕阅读器**: 完整的标签和提示文本支持
- **焦点管理**: 清晰的焦点指示和逻辑顺序
- **语音反馈**: 操作状态的声音反馈

## 技术架构

### 1. 代码结构
```
tts_role_exporter/
├── main.py                 # 主程序入口
├── config/                 # 配置文件目录
│   ├── providers.json      # 提供商配置
│   └── settings.json       # 程序设置
├── ui/                     # 界面模块
│   ├── main_frame.py       # 主界面
│   ├── provider_dialog.py  # 提供商管理对话框
│   └── config_dialog.py    # 提供商配置对话框
├── core/                   # 核心功能模块
│   ├── provider_manager.py # 提供商管理器
│   ├── network_scanner.py  # 网络扫描器
│   ├── tts_client.py       # TTS客户端
│   └── json_exporter.py    # JSON导出器
├── utils/                  # 工具模块
│   ├── accessibility.py    # 无障碍工具
│   ├── file_utils.py       # 文件操作工具
│   └── network_utils.py    # 网络工具
└── README.md              # 项目说明文档
```

### 2. 模块职责

#### 核心模块
- **ProviderManager**: 管理TTS提供商配置，提供统一的API接口
- **NetworkScanner**: 负责局域网内TTS服务器的发现和验证
- **TTSClient**: 处理与TTS服务的通信，包括角色获取和语音合成
- **JSONExporter**: 将角色数据导出为阅读软件兼容的JSON格式

#### 界面模块
- **MainFrame**: 主界面，包含所有用户交互控件
- **ProviderDialog**: 提供商管理界面，支持增删改查操作
- **ConfigDialog**: 提供商配置界面，动态生成配置表单

#### 工具模块
- **Accessibility**: 提供无障碍支持的工具函数
- **FileUtils**: 文件读写、配置文件管理
- **NetworkUtils**: 网络请求、URL处理等工具函数

## 界面设计

### 1. 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│ 语音合成角色导出工具                                          │
├─────────────────────────────────────────────────────────────┤
│ [方案选择组合框 ▼] [刷新按钮]                               │
│                                                             │
│ [角色列表]                                                  │
│ ☑ 忧伤女声.pt                                               │
│ ☐ jok老师.pt                                                │
│ ☑ 温柔的小女生.pt                                           │
│ ☐ 董卿抒情.pt                                               │
│ ...                                                        │
│                                                             │
│ 语音试听文本:                                              │
│ [这是一段默认的试听文本，用户可以编辑这个文本来...]          │
│                                                             │
│ 语速: [1.0 ▲▼]  音量: [1.0 ▲▼]                             │
│                                                             │
│ [全选] [反选] [导出为JSON]                                 │
├─────────────────────────────────────────────────────────────┤
│ 操作(C) │ 帮助(H) │ 关于(A) │ 退出(E)                        │
└─────────────────────────────────────────────────────────────┘
```

### 2. 控件详细说明

#### 方案选择组合框
- **功能**: 选择已配置的TTS提供商
- **显示格式**: 
  - 有自定义名称: `自定义名称 - 提供商名称`
  - 无自定义名称: `提供商名称`
- **快捷键**: Alt+S

#### 刷新按钮
- **功能**: 从选定提供商的API获取最新角色列表
- **快捷键**: Alt+R
- **状态反馈**: 刷新过程中显示进度，完成后提示结果

#### 角色列表
- **类型**: CheckListBox（复选框列表）
- **操作**: 
  - 空格键: 选中/取消选中
  - 回车键: 试听当前角色
  - 上下键: 导航选择
- **多选**: 支持批量选择多个角色

#### 语音试听文本框
- **类型**: TextCtrl（多行文本框）
- **默认内容**: 预设100字试听文本
- **功能**: 用户可以编辑试听文本内容

#### 语速/音量控件
- **类型**: SpinCtrl（数值选择控件）
- **范围**: 0.5 - 2.0
- **步长**: 0.1
- **操作**: 支持上下键调节和直接输入数值

#### 批量操作按钮
- **全选**: 选中列表中所有角色
- **反选**: 反转当前选择状态
- **导出**: 将选中的角色导出为JSON文件

### 3. 提供商管理界面

```
┌─────────────────────────────────────────────────────────────┐
│ 提供商管理                                                  │
├─────────────────────────────────────────────────────────────┤
│ 已配置的提供商:                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 我的TTS - index TTS                                      │ │
│ │ 本地服务器 - index TTS                                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [新建] [编辑] [删除] [搜索局域网]                           │
│                                                             │
│ [关闭]                                                     │
└─────────────────────────────────────────────────────────────┘
```

### 4. 提供商配置界面

```
┌─────────────────────────────────────────────────────────────┐
│ 配置index TTS提供商                                          │
├─────────────────────────────────────────────────────────────┤
│ 提供商类型: [index TTS ▼]                                   │
│                                                             │
│ 自定义名称: [我的TTS          ]                             │
│ 服务器地址: [192.168.1.100    ] [搜索局域网]                │
│ Web接口端口: [7860            ]                             │
│ 合成接口端口: [9880           ]                             │
│                                                             │
│ 语音试听文本:                                              │
│ [这是一段默认的试听文本，用于测试语音合成效果...]            │
│                                                             │
│ [保存] [取消]                                              │
└─────────────────────────────────────────────────────────────┘
```

## 数据存储

### 1. 提供商配置文件 (providers.json)

```json
{
  "providers": [
    {
      "id": "provider_001",
      "type": "index_tts",
      "custom_name": "我的TTS",
      "server_address": "192.168.1.100",
      "web_port": 7860,
      "synth_port": 9880,
      "enabled": true,
      "created_time": "2024-01-01T10:00:00Z",
      "last_used": "2024-01-01T15:30:00Z"
    }
  ],
  "default_provider": "provider_001"
}
```

### 2. 程序设置文件 (settings.json)

```json
{
  "window": {
    "width": 800,
    "height": 600,
    "maximized": false
  },
  "audio": {
    "default_speed": 1.0,
    "default_volume": 1.0,
    "preview_text": "这是一段默认的试听文本，用户可以编辑这个文本来测试语音合成效果。"
  },
  "network": {
    "scan_timeout": 5,
    "max_threads": 50,
    "scan_ranges": ["192.168.1.1-254", "192.168.0.1-254", "10.0.0.1-254"]
  },
  "export": {
    "output_directory": "./exports",
    "filename_template": "tts_roles_{timestamp}.json"
  }
}
```

### 3. 导出的JSON格式

```json
[
  {
    "concurrentRate": "0",
    "contentType": "audio/wav",
    "enabledCookieJar": false,
    "id": -100,
    "lastUpdateTime": 1640995200000,
    "name": "忧伤女声.pt_我的TTS - index TTS",
    "url": "http://192.168.1.100:9880/?text={{speakText}}&speaker=忧伤女声.pt&speed=1.0&volume=1.0"
  }
]
```

## API接口

### 1. index TTS API

#### 角色列表获取
- **接口**: `GET /change_choices`
- **地址**: `http://{server}:{web_port}/`
- **方法**: Gradio API
- **返回**: 角色名称数组

```python
from gradio_client import Client

client = Client(f"http://{server}:{web_port}/")
roles = client.predict(api_name="/change_choices")
```

#### 语音合成
- **接口**: `GET /`
- **地址**: `http://{server}:{synth_port}/`
- **参数**:
  - `text`: 要合成的文本
  - `speaker`: 角色名称
  - `speed`: 语速 (0.5-2.0)
  - `volume`: 音量 (0.5-2.0)

#### 示例URL
```
http://192.168.1.100:9880/?text=你好世界&speaker=忧伤女声.pt&speed=1.0&volume=1.0
```

### 2. 网络扫描API

#### 端口扫描
- **目标端口**: 7860 (Web接口), 9880 (合成接口)
- **扫描范围**: 常见局域网段
- **验证方式**: 调用Gradio API确认服务类型

#### 服务器验证
```python
def verify_index_tts_server(ip, web_port):
    try:
        client = Client(f"http://{ip}:{web_port}/")
        roles = client.predict(api_name="/change_choices")
        return len(roles) > 0
    except:
        return False
```

## 无障碍设计

### 1. 键盘导航

#### 全局快捷键
- `Alt+C`: 打开操作菜单
- `Alt+S`: 聚焦方案选择组合框
- `Alt+R`: 刷新角色列表
- `Alt+A`: 全选角色
- `Alt+D`: 反选角色
- `Alt+E`: 导出JSON
- `Alt+F4`: 退出程序

#### 控件内快捷键
- `Tab`: 正向导航
- `Shift+Tab`: 反向导航
- `Space`: 选中/取消选中（列表项）
- `Enter`: 确认/试听
- `Esc`: 取消/关闭对话框
- `上下箭头`: 导航列表项
- `Page Up/Down`: 快速翻页

### 2. 屏幕阅读器支持

#### 控件标签
- **组合框**: "方案选择，当前选择：我的TTS - index TTS"
- **按钮**: "刷新角色列表按钮"
- **列表项**: "忧伤女声.pt，已选中"
- **文本框**: "语音试听文本，当前内容：这是一段试听文本"

#### 状态提示
- 操作成功："操作成功完成"
- 操作失败："操作失败，错误原因：网络连接超时"
- 进度提示："正在刷新角色列表，请稍候..."

### 3. 焦点管理

#### 焦点顺序
1. 方案选择组合框
2. 刷新按钮
3. 角色列表
4. 语音试听文本框
5. 语速控件
6. 音量控件
7. 全选按钮
8. 反选按钮
9. 导出按钮

#### 焦点指示
- 视觉焦点：明显的边框或背景色变化
- 程序焦点：通过wxPython的焦点事件管理
- 语音反馈：焦点变化时朗读控件信息

## 开发计划

### 第一阶段：基础框架
1. **项目结构搭建**
   - 创建目录结构
   - 设置开发环境
   - 配置版本控制

2. **主界面开发**
   - 创建基本窗口
   - 添加菜单系统
   - 实现基础控件布局

3. **配置文件管理**
   - 实现JSON配置读写
   - 创建配置文件模板
   - 实现配置验证

### 第二阶段：核心功能
1. **提供商管理**
   - 实现提供商CRUD操作
   - 创建配置对话框
   - 实现表单验证

2. **网络功能**
   - 实现index TTS API调用
   - 开发局域网扫描功能
   - 实现服务器验证

3. **角色管理**
   - 实现角色列表获取和显示
   - 添加角色选择功能
   - 实现试听功能

### 第三阶段：完善功能
1. **导出功能**
   - 实现JSON格式导出
   - 添加文件保存对话框
   - 实现批量导出

2. **无障碍优化**
   - 完善键盘导航
   - 添加屏幕阅读器支持
   - 优化焦点管理

3. **用户体验**
   - 添加进度提示
   - 实现错误处理
   - 优化界面布局

### 第四阶段：测试和发布
1. **功能测试**
   - 单元测试
   - 集成测试
   - 无障碍测试

2. **文档完善**
   - 用户手册
   - 开发文档
   - API文档

3. **发布准备**
   - 打包发布
   - 版本管理
   - 问题跟踪

## 配置文件结构

### 1. 提供商配置模板

```json
{
  "providers": [],
  "settings": {
    "default_speed": 1.0,
    "default_volume": 1.0,
    "preview_text": "这是一段默认的试听文本。",
    "window": {
      "width": 800,
      "height": 600
    }
  }
}
```

### 2. 网络扫描配置

```json
{
  "scan_settings": {
    "timeout": 5,
    "max_threads": 50,
    "ip_ranges": [
      "192.168.1.1-254",
      "192.168.0.1-254",
      "10.0.0.1-254",
      "127.0.0.1"
    ],
    "ports": {
      "index_tts": {
        "web": 7860,
        "synth": 9880
      }
    }
  }
}
```

### 3. 导出模板

```json
{
  "template": {
    "concurrentRate": "0",
    "contentType": "audio/wav",
    "enabledCookieJar": false,
    "id_base": -100,
    "url_template": "http://{server}:{port}/?text={{speakText}}&speaker={speaker}&speed={speed}&volume={volume}"
  }
}
```

## 扩展性考虑

### 1. 提供商扩展
- 为不同TTS服务提供商预留接口
- 支持自定义配置字段
- 模块化的API客户端设计

### 2. 界面扩展
- 动态UI生成机制
- 可配置的控件布局
- 事件驱动的交互系统

### 3. 功能扩展
- 插件系统架构
- 脚本扩展支持
- 外部工具集成

### 4. 数据格式扩展
- 多种导出格式支持
- 可配置的映射规则
- 版本兼容性处理

## 注意事项

### 1. 开发注意事项
- 严格遵循无障碍开发规范
- 保持代码结构清晰，便于后续扩展
- 完善的错误处理和日志记录
- 充分的单元测试和集成测试

### 2. 部署注意事项
- 提供完整的安装说明
- 包含所有依赖库
- 考虑不同操作系统的兼容性
- 提供版本更新机制

### 3. 维护注意事项
- 定期更新依赖库
- 修复发现的安全漏洞
- 回应用户反馈
- 持续改进用户体验

## 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。

## 贡献指南

欢迎提交 Issue 和 Pull Request 来改进本项目。

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- Email: [your-email@example.com]

---

**最后更新**: 2024-01-01
**版本**: 1.0.0
**作者**: [您的姓名]