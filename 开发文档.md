# LegadoTTSTool 开发文档

## 项目概述

### 项目简介
LegadoTTSTool 是一个专为盲人用户设计的语音合成角色管理工具，主要用于从各种 TTS（文本转语音）API 获取语音角色信息，并导出为阅读软件（Legado）可导入的 JSON 格式。

### 开发目标
1. **无障碍优先**: 所有功能都必须支持键盘操作和屏幕阅读器
2. **简单易用**: 界面简洁，操作流程清晰
3. **稳定可靠**: 网络请求和错误处理完善
4. **可扩展性**: 支持多种 TTS 服务提供商

### 目标用户
- 盲人用户或依赖屏幕阅读器的用户
- 需要管理 TTS 语音角色的用户
- 使用 Legado 阅读软件的用户

## 技术架构

### 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                           │
├─────────────────────────────────────────────────────────────┤
│  主界面  │  提供商管理  │  配置界面  │  导出界面              │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        业务逻辑层                           │
├─────────────────────────────────────────────────────────────┤
│ ProviderManager │ TTSClient │ NetworkScanner │ JSONExporter │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据存储层                           │
├─────────────────────────────────────────────────────────────┤
│   providers.json   │   settings.json   │   导出文件         │
└─────────────────────────────────────────────────────────────┘
```

### 模块职责划分

#### 核心业务模块
- **ProviderManager**: 提供商配置管理，包括增删改查操作
- **TTSClient**: TTS 服务通信，处理角色获取和语音合成
- **NetworkScanner**: 局域网 TTS 服务器发现和验证
- **JSONExporter**: 角色数据格式转换和导出

#### 界面模块
- **MainFrame**: 主界面协调器，管理所有用户交互
- **ProviderDialog**: 提供商管理界面
- **ConfigDialog**: 动态配置表单生成器

#### 工具模块
- **Accessibility**: 无障碍功能支持
- **FileUtils**: 文件操作和配置管理
- **NetworkUtils**: 网络通信工具

## 项目结构

```
LegadoTTSTool/
├── main.py                 # 主程序入口
├── config/                 # 配置文件目录
│   ├── providers.json      # 提供商配置
│   └── settings.json       # 程序设置
├── ui/                     # 界面模块
│   ├── main_frame.py       # 主界面
│   ├── provider_dialog.py  # 提供商管理对话框
│   └── config_dialog.py    # 提供商配置对话框
├── core/                   # 核心功能模块
│   ├── provider_manager.py # 提供商管理器
│   ├── network_scanner.py  # 网络扫描器
│   ├── tts_client.py       # TTS 客户端
│   └── json_exporter.py    # JSON 导出器
├── utils/                  # 工具模块
│   ├── accessibility.py    # 无障碍工具
│   └── file_utils.py       # 文件操作工具
├── requirements.txt        # Python 依赖
├── README.md              # 项目说明文档
├── 项目文档.md             # 项目开发文档
└── 开发文档.md             # 详细开发文档
```

## 核心功能实现

### 1. 提供商管理系统

#### 数据结构
```json
{
  "providers": [
    {
      "id": "uuid-string",
      "type": "index_tts",
      "custom_name": "我的 TTS",
      "enabled": true,
      "server_address": "127.0.0.1",
      "web_port": 7860,
      "synth_port": 9880,
      "preview_text": "试听文本",
      "created_time": "2024-01-01T00:00:00Z",
      "last_used": null
    }
  ],
  "version": "1.0.0",
  "last_updated": "2024-01-01T00:00:00Z"
}
```

#### CRUD 操作
- **创建**: 生成 UUID，设置创建时间，验证配置
- **读取**: 支持按名称、ID、类型查询
- **更新**: 验证数据，更新时间戳
- **删除**: 移除配置，清理关联数据

### 2. TTS 客户端

#### API 调用封装
```python
def _get_index_tts_roles(self, provider):
    """获取 index TTS 角色列表"""
    # 重定向标准输出避免 Unicode 编码问题
    old_stdout = sys.stdout
    sys.stdout = io.StringIO()
    
    try:
        client = Client(f"http://{server_address}:{web_port}/")
        result = client.predict(api_name="/change_choices")
        
        # 解析复杂数据结构
        if isinstance(result, dict) and 'choices' in result:
            roles = [choice[0] for choice in result['choices']]
        elif isinstance(result, list):
            roles = result
        
        return roles
    finally:
        sys.stdout = old_stdout
```

#### 错误处理
- 网络连接超时
- API 格式错误
- 编码问题处理
- 服务器验证失败

### 3. 网络扫描器

#### 多线程扫描
```python
def scan_index_tts_servers(self):
    """扫描局域网内的 index TTS 服务器"""
    ip_ranges = ["192.168.1.1-254", "192.168.0.1-254", "10.0.0.1-254"]
    threads = []
    results = []
    
    for ip_range in ip_ranges:
        thread = threading.Thread(
            target=self._scan_range,
            args=(ip_range, results)
        )
        threads.append(thread)
        thread.start()
    
    # 等待所有线程完成
    for thread in threads:
        thread.join()
    
    return results
```

#### 服务器验证
- 端口连通性检查
- Gradio API 调用测试
- 响应格式验证

## 用户界面设计

### 主界面布局
```
┌─────────────────────────────────────────────────────────────┐
│ 语音合成角色导出工具                                          │
├─────────────────────────────────────────────────────────────┤
│ [方案选择组合框 ▼] [刷新按钮]                               │
│                                                             │
│ 语音角色：                                                  │
│ ☑ 忧伤女声.pt                                               │
│ ☐ jok老师.pt                                                │
│ ☑ 温柔的小女生.pt                                           │
│ ...                                                        │
│                                                             │
│ 语音试听文本:                                              │
│ [这是一段默认的试听文本，用户可以编辑这个文本来...]          │
│                                                             │
│ 语速: [1.0]  音量: [1.0]                                   │
│                                                             │
│ [全选] [反选] [导出为JSON]                                 │
├─────────────────────────────────────────────────────────────┤
│ 操作(C) │ 帮助(H) │ 关于(A) │ 退出(E)                        │
└─────────────────────────────────────────────────────────────┘
```

### 控件说明

#### 方案选择组合框
- **功能**: 选择已配置的 TTS 提供商
- **显示格式**: `自定义名称 - 提供商类型`
- **快捷键**: Alt+S

#### 角色列表
- **类型**: CheckListBox（复选框列表）
- **状态显示**: 获取时显示"正在获取音色..."
- **过滤功能**: 自动过滤"使用参考音频"

#### 参数控制
- **语速**: 文本框输入，范围 0.5-2.0，支持回车确认
- **音量**: 文本框输入，范围 0.5-2.0，支持回车确认
- **验证**: 自动验证输入范围，无效时恢复默认值

## 无障碍设计

### 键盘导航
- **Tab 键**: 正向导航
- **Shift+Tab**: 反向导航
- **空格键**: 选中/取消选中
- **回车键**: 确认/试听
- **Esc 键**: 取消/关闭

### 全局快捷键
- **Alt+C**: 打开操作菜单
- **Alt+S**: 聚焦方案选择
- **Alt+R**: 刷新角色列表
- **Alt+A**: 全选角色
- **Alt+D**: 反选角色
- **Alt+E**: 导出 JSON

### 屏幕阅读器支持
- **完整标签**: 所有控件都有清晰的无障碍名称
- **状态提示**: 操作状态实时反馈
- **焦点管理**: 清晰的焦点指示和逻辑顺序

## 数据处理

### 角色数据过滤
```python
# 过滤特殊选项
filtered_roles = [role for role in event.roles if role != "使用参考音频"]

# 更新显示
self.current_roles = filtered_roles
self.role_list.Clear()
for role in filtered_roles:
    self.role_list.Append(role)
```

### JSON 导出格式
```json
[
  {
    "concurrentRate": "0",
    "contentType": "audio/wav",
    "enabledCookieJar": false,
    "id": 1640995200000,
    "lastUpdateTime": 1640995200000,
    "name": "忧伤女声.pt_我的TTS",
    "url": "http://127.0.0.1:9880/?text={{speakText}}&speaker=忧伤女声.pt&speed=1.0&volume=1.0"
  }
]
```

### ID 生成策略
```python
def generate_unique_id(existing_ids=None):
    """生成唯一的正数时间戳 ID"""
    timestamp = int(time.time() * 1000)
    
    # 确保唯一性
    if existing_ids:
        while timestamp in existing_ids:
            timestamp += 1
    
    return timestamp
```

## 错误处理机制

### 网络错误处理
```python
try:
    roles = self.tts_client.get_roles(provider)
    # 发送更新事件
    evt = RoleUpdateEvent(roles=roles)
    wx.PostEvent(self, evt)
except Exception as e:
    # 发送错误事件
    evt = RoleUpdateEvent(error=str(e))
    wx.PostEvent(self, evt)
```

### 用户友好提示
- 网络连接失败：检查服务器配置和网络连接
- API 调用失败：验证服务器状态和端口配置
- 数据解析失败：检查 API 兼容性

### 程序退出处理
```python
def OnExit(self):
    """应用程序退出时的清理工作"""
    try:
        # 清理资源
        if hasattr(self, 'provider_manager'):
            self.provider_manager = None
        if hasattr(self, 'frame'):
            self.frame = None
    except Exception as e:
        print(f"退出清理失败: {e}")
    
    return super().OnExit()
```

## 安装和部署

### 环境要求
- Python 3.8+
- Windows 10/11
- 支持的 TTS 服务（index TTS）

### 依赖库
```
wxPython==4.2.1
requests==2.31.0
gradio_client==0.8.1
pygame==2.5.2
uuid==1.30
```

### 安装步骤
1. **克隆仓库**
   ```bash
   git clone https://github.com/yzfycz/LegadoTTSTool.git
   cd LegadoTTSTool
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **运行程序**
   ```bash
   python main.py
   ```

### 配置文件
程序首次运行会自动创建 `config/providers.json` 配置文件：

```json
{
  "providers": [
    {
      "id": "56bacf8b-82cc-4aa0-9999-9ad1114b435d",
      "type": "index_tts",
      "custom_name": "我的",
      "enabled": true,
      "server_address": "127.0.0.1",
      "web_port": 7860,
      "synth_port": 9880,
      "preview_text": "这是一段默认的试听文本，用于测试语音合成效果。"
    }
  ],
  "version": "1.0.0",
  "last_updated": "2024-01-01T00:00:00Z"
}
```

## 常见问题解决

### 1. 程序启动失败
**问题**: Python 模块导入错误
**解决**: 
```bash
pip install -r requirements.txt
```

### 2. 网络连接失败
**问题**: 无法连接到 TTS 服务器
**解决**:
- 检查服务器地址和端口
- 确认 TTS 服务正在运行
- 验证网络连通性

### 3. 角色获取失败
**问题**: API 返回格式错误
**解决**:
- 确认使用的是 index TTS 服务
- 检查 Gradio API 版本兼容性
- 查看服务器日志

### 4. 无障碍功能异常
**问题**: 屏幕阅读器无法正确读取控件
**解决**:
- 确认使用支持的屏幕阅读器（NVDA、JAWS）
- 检查 wxPython 版本兼容性
- 重启屏幕阅读器

### 5. 程序退出崩溃
**问题**: 退出时出现 RecursionError
**解决**:
- 使用最新版本的程序
- 检查是否有其他程序占用端口
- 确认系统资源充足

## 开发指南

### 代码规范
- **命名规范**: 使用有意义的英文变量名和函数名
- **注释规范**: 关键功能必须有中文注释
- **异常处理**: 所有可能失败的操作都必须有异常处理
- **无障碍**: 所有新增功能都必须支持无障碍操作

### 调试技巧
```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 捕获异常并记录
try:
    # 可能失败的代码
except Exception as e:
    logging.error(f"操作失败: {e}")
    import traceback
    traceback.print_exc()
```

### 测试方法
1. **单元测试**: 测试各个模块的核心功能
2. **集成测试**: 测试模块间的协作
3. **无障碍测试**: 使用屏幕阅读器验证操作流程
4. **用户测试**: 邀请目标用户进行实际使用测试

## 版本历史

### v1.0.0 (2024-08-24)
- **初始版本发布**
- **基础功能**: 提供商管理、角色获取、JSON 导出
- **无障碍支持**: 完整的键盘导航和屏幕阅读器支持
- **网络功能**: 局域网扫描和服务器验证

### 修复版本 (2024-08-25)
- **修复 API 调用问题**: 解决 Gradio 客户端编码问题
- **修复界面更新**: 提供商修改后立即生效
- **修复退出错误**: 解决程序退出时的递归错误
- **优化用户体验**: 状态显示和智能过滤

## 贡献指南

### 开发环境设置
1. Fork 本仓库
2. 创建特性分支: `git checkout -b feature/新功能`
3. 提交更改: `git commit -m '添加新功能'`
4. 推送到分支: `git push origin feature/新功能`
5. 打开 Pull Request

### 代码审查要点
- 无障碍功能完整性
- 错误处理机制
- 代码风格一致性
- 中文注释完整性

## 许可证

本项目采用 MIT 许可证 - 详见 LICENSE 文件。

## 联系方式

- **GitHub Issues**: [提交问题](https://github.com/yzfycz/LegadoTTSTool/issues)
- **Email**: yzfycz@example.com

## 致谢

- index TTS 服务提供商
- wxPython GUI 框架
- Legado 阅读软件
- 所有贡献者和测试用户

---

**最后更新**: 2024-08-25
**版本**: 1.0.0
**维护者**: yzfycz